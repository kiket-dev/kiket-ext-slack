model_version: "1.0"
extension:
  id: dev.kiket.ext.slack
  name: Slack Notifications
  version: 1.0.0
  description: Send notifications via Slack channels and direct messages using OAuth 2.0
  author: Kiket Team
  homepage: https://github.com/kiket-dev/kiket-ext-slack
  delivery: http
  callback:
    url: ${EXTENSION_BASE_URL}
    secret: env.KIKET_WEBHOOK_SECRET
    timeout: 30000
    required: true
  activationEvents:
    - issue.created
    - issue.transitioned
    - issue.assigned
    - issue.commented
    - workflow.sla_breach
    - workflow.before_transition
  permissions:
    - issues:read
    - users:read
    - notifications:write
    - workflows:read
  capabilities:
    - notifications
    - chat
    - direct-messages
    - channels
    - rich-formatting
    - attachments
    - threading
    - reactions
    - approvals
  hooks:
    - event: issue.created
      template: issue_created_message
      timeout: 5000
      retries: 1
      description: Send notification when issue is created
    - event: issue.transitioned
      timeout: 5000
      retries: 1
      description: Send notification on issue state transitions
    - event: issue.assigned
      timeout: 5000
      retries: 1
      description: Notify users when assigned to issues
    - event: issue.commented
      timeout: 5000
      retries: 1
      description: Send notification for new comments
    - event: workflow.sla_breach
      template: sla_breach_message
      timeout: 5000
      retries: 2
      description: Alert teams of SLA violations
    - event: workflow.before_transition
      template: approval_request_message
      timeout: 8000
      retries: 1
      description: Request approvals before workflow transitions
  contributes:
    commands:
      - command: slack.sendMessage
        title: Send Slack Message
        description: Send a message to a Slack channel or user
        category: Notifications
        icon: bi-slack
        keywords: ["slack", "chat", "message", "notify"]
        handler:
          type: extension_event
          event: slack.sendMessage
      - command: slack.sendThreadedMessage
        title: Send Threaded Reply
        description: Send a threaded reply to an existing message
        category: Notifications
        icon: bi-chat-dots
        keywords: ["slack", "thread", "reply", "message"]
        handler:
          type: extension_event
          event: slack.sendThreadedMessage
      - command: slack.validateChannel
        title: Validate Slack Channel
        description: Test Slack channel or user configuration
        category: Settings
        icon: bi-check-circle
        keywords: ["slack", "validate", "test", "channel"]
        handler:
          type: extension_event
          event: slack.validateChannel
      - command: slack.requestApproval
        title: Request Approval in Slack
        description: Send an interactive approval request
        category: Workflows
        icon: bi-hand-thumbs-up
        keywords: ["slack", "approval", "workflow", "request"]
        permissions:
          - manager
          - executive
        handler:
          type: extension_event
          event: slack.requestApproval
  configuration:
    # Authentication - org-wide credentials (shared across all projects)
    SLACK_BOT_TOKEN:
      type: string
      secret: true
      required: true
      scope: extension
      label: Slack Bot Token
      description: Slack Bot User OAuth Token (xoxb-...)
    # General Settings
    default_message_format:
      type: string
      default: "mrkdwn"
      description: Default message format (mrkdwn or plain)
    retry_attempts:
      type: integer
      default: "3"
      description: Number of retry attempts for failed deliveries
    timeout_seconds:
      type: integer
      default: "30"
      description: Request timeout in seconds
    link_names:
      type: boolean
      default: "true"
      description: Find and link channel names and usernames
    # Rich Configuration - Message Templates
    issue_created_message:
      type: template
      editor: template
      language: liquid
      label: Issue Created Message
      description: Slack message template for new issues
      default: |
        :ticket: *New Issue Created*

        *{{ issue.title }}*
        Type: {{ issue.type }} | Priority: {{ issue.priority }}
        Created by: {{ issue.created_by.name }}

        {% if issue.description %}
        > {{ issue.description }}
        {% endif %}

        <{{ issue.url }}|View Issue>
      variables:
        - name: issue
          type: object
          properties:
            - { name: id, type: number }
            - { name: title, type: string }
            - { name: type, type: string }
            - { name: priority, type: string }
            - { name: description, type: string }
            - { name: url, type: string }
            - { name: created_by, type: object }
    sla_breach_message:
      type: template
      editor: template
      language: liquid
      label: SLA Breach Alert Message
      description: Urgent Slack message for SLA violations
      default: |
        :rotating_light: *SLA BREACH ALERT* :rotating_light:

        *{{ issue.title }}*
        Policy: {{ sla.policy_name }}
        Target: {{ sla.target_time }} | Actual: {{ sla.actual_time }}
        *Exceeded by: {{ sla.exceeded_by }}*

        <{{ issue.url }}|Take Action Now>
      variables:
        - name: issue
          type: object
        - name: sla
          type: object
          properties:
            - { name: policy_name, type: string }
            - { name: target_time, type: string }
            - { name: actual_time, type: string }
            - { name: exceeded_by, type: string }
      validation:
        required_variables:
          - issue.title
          - sla.policy_name
    approval_request_message:
      type: template
      editor: template
      language: liquid
      label: Approval Request Message
      description: Interactive approval request message
      default: |
        :clipboard: *Approval Required*

        *{{ issue.title }}*
        Requested by: {{ requester.name }}
        Transition: {{ transition.from }} â†’ {{ transition.to }}

        {% if reason %}
        > {{ reason }}
        {% endif %}

  # Setup Wizard - guides users through extension configuration
  setup:
    # Step 1: Slack Bot Token - references configuration key above
    - secrets:
        title: Connect to Slack
        description: Enter your Slack Bot Token to enable notifications
        required: true
        help_url: https://api.slack.com/apps
        collect:
          - SLACK_BOT_TOKEN

    # Step 2: Default Channel Configuration
    - configure:
        title: Configure Default Channel
        description: Set up where notifications are sent by default
        fields:
          - key: default_channel
            type: text
            label: Default Channel
            description: Channel ID or name for default notifications
            placeholder: "#general or C01234567"
            required: false
          - key: link_names
            type: boolean
            label: Link Usernames
            description: Automatically link @mentions and #channels
            default: true
          - key: default_message_format
            type: select
            label: Message Format
            options:
              - { value: mrkdwn, label: Slack Markdown }
              - { value: plain, label: Plain Text }
            default: mrkdwn

    # Step 3: Test Connection
    - test:
        title: Test Connection
        description: Send a test message to verify your Slack bot is working
        action: slack.validateChannel
        successMessage: Successfully connected to Slack! Check your channel for the test message.
        required: false

    # Step 4: Getting Started Info
    - info:
        title: Setup Complete
        content: |
          ## You're all set! ðŸŽ‰

          Your Slack integration is now configured. Here's what you can do:

          - **Issue notifications** will appear in your configured channel
          - **Approval requests** can be sent interactively
          - **Threaded replies** keep conversations organized

          ### Available Commands

          - `/slack.sendMessage` - Send a message to any channel
          - `/slack.requestApproval` - Send an interactive approval request

          ### Tips

          - Invite the bot to private channels for them to work
          - Use threads for related notifications
          - Enable reactions for quick acknowledgments
        links:
          - label: Slack App Settings
            url: https://api.slack.com/apps
            icon: gear
          - label: Kiket Documentation
            url: https://docs.kiket.dev/extensions/slack
            icon: book

  custom_data:
    permissions:
      - module: dev.kiket.ext.slack.deliveries
        operations: [read, write]
  assets:
    icon: ./public/icon.svg
  hosting: internal
